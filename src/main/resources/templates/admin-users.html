<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Navigation -->
    <div th:replace="~{fragments/nav_admin :: nav}"></div>

    <div class="users-container">
        <div class="users-header">
            <h2>User Management</h2>
            <p>View, edit, and manage all system users</p>
            <div style="margin-top: 1rem;">
                <a href="/admin/create-user" class="btn" style="background-color: #27ae60; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 4px; display: inline-block;">
                    âž• Create New User
                </a>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="searchName">Search by Name</label>
                    <input type="text" id="searchName" placeholder="Enter name...">
                </div>
                <div class="filter-group">
                    <label for="filterUserType">User Type</label>
                    <select id="filterUserType">
                        <option value="">All Types</option>
                        <option value="Employee">Employee</option>
                        <option value="Manager">Manager</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterDepartment">Department</label>
                    <select id="filterDepartment">
                        <option value="">All Departments</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Design">Design</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Quality Assurance">Quality Assurance</option>
                        <option value="IT">IT</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterStatus">Status</label>
                    <select id="filterStatus">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn-filter" onclick="applyFilters()">Apply Filters</button>
                <button class="btn-clear" onclick="clearFilters()">Clear</button>
            </div>
        </div>

        <div class="users-table-container">
            <table class="users-table" th:if="${not #lists.isEmpty(users)}">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Organization</th>
                        <th>Role</th>
                        <th>PTO Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr th:each="user : ${users}">
                        <td th:text="${user.id}">1</td>
                        <td th:text="${user.firstName + ' ' + user.lastName}">John Doe</td>
                        <td th:text="${user.email}">john.doe@company.com</td>
                        <td th:text="${user.organizationName != null ? user.organizationName : 'N/A'}">Company Co.</td>
                        <td th:text="${user.roleName != null ? user.roleName : 'N/A'}">Developer</td>
                        <td th:text="${user.ptoBalance}">80.0</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-view" 
                                        th:data-user-id="${user.id}"
                                        th:data-name="${user.firstName + ' ' + user.lastName}"
                                        th:data-email="${user.email}"
                                        th:data-org="${user.organizationName != null ? user.organizationName : 'N/A'}"
                                        th:data-role="${user.roleName != null ? user.roleName : 'N/A'}"
                                        th:data-pto="${user.ptoBalance}"
                                        onclick="viewUser(this)">
                                    View
                                </button>
                                <a th:href="@{/admin/users/edit(userId=${user.id})}" class="btn-small btn-edit">
                                    Edit
                                </a>
                                <a th:href="@{/admin/view-timesheets/{id}(id=${user.id})}" class="btn-small btn-timesheets">
                                    Timesheets
                                </a>
                                <button class="btn-small btn-delete" 
                                        th:data-user-id="${user.id}"
                                        th:data-name="${user.firstName + ' ' + user.lastName}"
                                        onclick="showDeleteModal(this.getAttribute('data-user-id'), this.getAttribute('data-name'))">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="no-users" th:if="${#lists.isEmpty(users)}">
                <h3>No Users Found</h3>
                <p>There are no users in the system at this time.</p>
            </div>
        </div>
    </div>

    <!-- View User Details Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Details</h3>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete User</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                <p style="color: #e74c3c; font-weight: 600;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <form id="deleteForm" method="post" th:action="@{/admin/users/delete}" style="display: inline;">
                    <input type="hidden" name="userId" id="deleteUserId">
                    <button type="submit" class="btn-confirm-delete">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function viewUser(button) {
            const modalBody = document.getElementById('viewModalBody');
            
            modalBody.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Employee ID:</span>
                    <span class="info-value">${button.getAttribute('data-user-id')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value">${button.getAttribute('data-name')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${button.getAttribute('data-email')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Organization:</span>
                    <span class="info-value">${button.getAttribute('data-org')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Role:</span>
                    <span class="info-value">${button.getAttribute('data-role')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">PTO Balance:</span>
                    <span class="info-value">${button.getAttribute('data-pto')} hours</span>
                </div>
            `;
            
            document.getElementById('viewModal').style.display = 'block';
        }

        function closeViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        function showDeleteModal(userId, userName) {
            document.getElementById('deleteModal').style.display = 'block';
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserId').value = userId;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        function applyFilters() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterUserType = document.getElementById('filterUserType').value;
            const filterDepartment = document.getElementById('filterDepartment').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const org = row.cells[3].textContent.trim();
                const role = row.cells[4].textContent.trim();
                
                const matchesName = !searchName || name.includes(searchName);
                const matchesOrg = !filterDepartment || org === filterDepartment;
                const matchesRole = !filterUserType || role === filterUserType;
                
                if (matchesName && matchesOrg && matchesRole) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('filterUserType').value = '';
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterStatus').value = '';
            
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == viewModal) {
                closeViewModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>