<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Navigation -->
    <div th:replace="~{fragments/nav_admin :: nav}"></div>

    <div class="users-container">
        <div class="users-header">
            <h2>User Management</h2>
            <p>View, edit, and manage all system users</p>
        </div>

        <!-- Improved Filters Section -->
        <div class="filters-section" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                <div style="order: -1;"> <a href="/admin/create-user" class="btn" style="background-color: #27ae60; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; display: inline-block; white-space: nowrap; height: 38px; line-height: 25px;">
                        ‚ûï Create New User
                    </a>
                </div>

                <div style="flex: 1; min-width: 180px;">
                    <input type="text" id="searchName" placeholder="üîç Search by name..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                           oninput="applyFilters()">
                </div>
                <div style="flex: 1; min-width: 180px;">
                    <input type="text" id="searchEmail" placeholder="üìß Search by email..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                           oninput="applyFilters()">
                </div>
                <div style="flex: 0.8; min-width: 150px;">
                    <select id="filterOrganization" 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="applyFilters()">
                        <option value="">üè¢ All Organizations</option>
                        <option th:each="org : ${organizations}" th:value="${org}" th:text="${org}">Organization</option>
                    </select>
                </div>
                <div style="flex: 0.8; min-width: 150px;">
                    <select id="filterRole" 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="applyFilters()">
                        <option value="">üë§ All Roles</option>
                        <option th:each="role : ${roles}" th:value="${role}" th:text="${role}">Role</option>
                    </select>
                </div>
                <button class="btn-clear" onclick="clearFilters()" 
                        style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                    Clear All
                </button>
            </div>
            <div id="filterStatus" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6c757d;"></div>
        </div>

        <div class="users-table-container">
            <table class="users-table" th:if="${not #lists.isEmpty(users)}">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Organization</th>
                        <th>Role</th>
                        <th>PTO Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr th:each="user : ${users}">
                        <td th:text="${user.id}">1</td>
                        <td th:text="${user.firstName + ' ' + user.lastName}">John Doe</td>
                        <td th:text="${user.email}">john.doe@company.com</td>
                        <td th:text="${user.organizationName != null ? user.organizationName : 'N/A'}">Company Co.</td>
                        <td th:text="${user.roleName != null ? user.roleName : 'N/A'}">Developer</td>
                        <td th:text="${user.ptoBalance}">80.0</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-view" 
                                        th:data-user-id="${user.id}"
                                        th:data-name="${user.firstName + ' ' + user.lastName}"
                                        th:data-email="${user.email}"
                                        th:data-org="${user.organizationName != null ? user.organizationName : 'N/A'}"
                                        th:data-role="${user.roleName != null ? user.roleName : 'N/A'}"
                                        th:data-pto="${user.ptoBalance}"
                                        onclick="viewUser(this)">
                                    View
                                </button>
                                <a th:href="@{/admin/users/edit(userId=${user.id})}" class="btn-small btn-edit">
                                    Edit
                                </a>
                                <a th:href="@{/admin/view-timesheets/{id}(id=${user.id})}" class="btn-small btn-timesheets">
                                    Timesheets
                                </a>
                                <button class="btn-small btn-delete" 
                                        th:data-user-id="${user.id}"
                                        th:data-name="${user.firstName + ' ' + user.lastName}"
                                        onclick="showDeleteModal(this.getAttribute('data-user-id'), this.getAttribute('data-name'))">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="no-users" th:if="${#lists.isEmpty(users)}">
                <h3>No Users Found</h3>
                <p>There are no users in the system at this time.</p>
            </div>
        </div>
    </div>

    <!-- View User Details Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Details</h3>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete User</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                <p style="color: #e74c3c; font-weight: 600;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <form id="deleteForm" method="post" th:action="@{/admin/users/delete}" style="display: inline;">
                    <input type="hidden" name="userId" id="deleteUserId">
                    <button type="submit" class="btn-confirm-delete">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function viewUser(button) {
            const modalBody = document.getElementById('viewModalBody');
            
            modalBody.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Employee ID:</span>
                    <span class="info-value">${button.getAttribute('data-user-id')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value">${button.getAttribute('data-name')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${button.getAttribute('data-email')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Organization:</span>
                    <span class="info-value">${button.getAttribute('data-org')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Role:</span>
                    <span class="info-value">${button.getAttribute('data-role')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">PTO Balance:</span>
                    <span class="info-value">${button.getAttribute('data-pto')} hours</span>
                </div>
            `;
            
            document.getElementById('viewModal').style.display = 'block';
        }

        function closeViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        function showDeleteModal(userId, userName) {
            document.getElementById('deleteModal').style.display = 'block';
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserId').value = userId;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        function applyFilters() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchEmail = document.getElementById('searchEmail').value.toLowerCase();
            const filterOrganization = document.getElementById('filterOrganization').value;
            const filterRole = document.getElementById('filterRole').value;
            
            const rows = document.querySelectorAll('#usersTableBody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const email = row.cells[2].textContent.toLowerCase();
                const org = row.cells[3].textContent.trim();
                const role = row.cells[4].textContent.trim();
                
                const matchesName = !searchName || name.includes(searchName);
                const matchesEmail = !searchEmail || email.includes(searchEmail);
                const matchesOrg = !filterOrganization || org === filterOrganization;
                const matchesRole = !filterRole || role === filterRole;
                
                if (matchesName && matchesEmail && matchesOrg && matchesRole) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update filter status
            const statusDiv = document.getElementById('filterStatus');
            const totalCount = rows.length;
            
            if (visibleCount < totalCount) {
                statusDiv.textContent = `Showing ${visibleCount} of ${totalCount} users`;
            } else {
                statusDiv.textContent = '';
            }
        }

        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('filterOrganization').value = '';
            document.getElementById('filterRole').value = '';
            
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            
            document.getElementById('filterStatus').textContent = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == viewModal) {
                closeViewModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>