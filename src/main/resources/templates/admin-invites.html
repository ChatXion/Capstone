<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Invite Codes - Admin</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .modal-body select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M7 7l3 3 3-3' stroke='%234b5563' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            cursor: pointer;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .modal-body select:focus {
            border-color: #2563eb; /* Blue focus color */
            outline: 0;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
        }

        /* Ensure textarea/input styles are also defined for consistency */
        .modal-body textarea, .modal-body input[type="text"], .modal-body input[type="email"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/nav_admin :: nav}"></div>

    <div class="registrations-container">
        <div class="registrations-header">
            <h2>Manage Invite Codes</h2>
            <p>View, create, and manage invitation codes for user registration</p>
            <button class="btn-confirm-approve" 
            onclick="showCreateModal()"
            style="display: inline-block; padding: 0.75rem 1.5rem; text-decoration: none; font-size: 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
                Create New Invite Code
            </button>
        </div>

        <div class="registrations-table-container">
            <table class="registrations-table" th:if="${not #lists.isEmpty(inviteCodes)}">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Assigned Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="code : ${inviteCodes}">
                        <td th:text="${code.code}">INV12345</td>
                        <td th:text="${code.description}">New Employee Onboarding</td>
                        <td th:text="${code.assigningRole.name}">STANDARD_USER</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" 
                                        th:data-code-id="${code.id}"
                                        th:data-code-description="${code.description}"
                                        th:data-code-role="${code.assigningRole.name}"
                                        onclick="showEditModal(this)">
                                    Edit
                                </button>
                                <button class="btn-small btn-deny" 
                                        th:data-code-id="${code.id}"
                                        th:data-code="${code.code}"
                                        onclick="showDeleteModal(this.getAttribute('data-code-id'), this.getAttribute('data-code'))">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="no-registrations" th:if="${#lists.isEmpty(inviteCodes)}">
                <h3>No Invite Codes Found</h3>
                <p>Create a new invite code to get started.</p>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Invite Code</h3>
            </div>
            <form id="createForm" method="post" th:action="@{/admin/invites/create}">
                <div class="modal-body">
                    <p>A new, unique code will be generated upon submission.</p>
                    
                    <label for="newDescription" style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Description:</label>
                    <textarea id="newDescription" name="description" required placeholder="e.g., Marketing Team Access" maxlength="255" rows="4"></textarea>

                    <label for="newRole" style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Assign Role:</label>
                    <select id="newRole" name="assignedRole" required>
                        <option th:each="role : ${availableRoles}" 
                                th:value="${role}" 
                                th:text="${role}">
                            ROLE_EXAMPLE
                        </option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn-confirm-approve">Generate & Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Invite Code</h3>
            </div>
            <form id="editForm" method="post" th:action="@{/admin/invites/edit}">
                <div class="modal-body">
                    <input type="hidden" name="id" id="editCodeId">
                    <p>Editing code: <strong id="editCodeDisplay"></strong></p>

                    <label for="editDescription" style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Description:</label>
                    <textarea id="editDescription" name="description" required placeholder="e.g., Marketing Team Access" maxlength="255" rows="4"></textarea>

                    <label for="editRole" style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Assign Role:</label>
                    <select id="editRole" name="assignedRole" required>
                        <option th:each="role : ${availableRoles}" 
                                th:value="${role}" 
                                th:text="${role}">
                            ROLE_EXAMPLE
                        </option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-confirm-approve">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Invite Code</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to **permanently delete** the invite code: <strong id="deleteCodeName"></strong>?</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <form id="deleteForm" method="post" th:action="@{/admin/invites/delete}" style="display: inline;">
                    <input type="hidden" name="codeId" id="deleteCodeId">
                    <button type="submit" class="btn-confirm-deny">Delete</button>
                </form>
            </div>
        </div>
    </div>


    <script>
        // --- CREATE Modal Functions ---
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            // Optional: Clear form fields on close
            document.getElementById('createForm').reset();
        }
        
        // --- EDIT Modal Functions ---
        function showEditModal(buttonElement) {
            const id = buttonElement.getAttribute('data-code-id');
            const description = buttonElement.getAttribute('data-code-description');
            const role = buttonElement.getAttribute('data-code-role');
            const codeName = buttonElement.closest('tr').querySelector('td:first-child').textContent; // Get the actual code from the table cell

            document.getElementById('editCodeId').value = id;
            document.getElementById('editCodeDisplay').textContent = codeName;
            document.getElementById('editDescription').value = description;
            
            // Set the correct option in the dropdown
            const editRoleSelect = document.getElementById('editRole');
            editRoleSelect.value = role;

            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // --- DELETE Modal Functions ---
        function showDeleteModal(id, code) {
            document.getElementById('deleteModal').style.display = 'block';
            document.getElementById('deleteCodeName').textContent = code;
            document.getElementById('deleteCodeId').value = id;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            
            if (event.target == createModal) {
                closeCreateModal();
            }
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>

    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>