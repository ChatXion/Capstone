<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Timesheet</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <div th:replace="~{fragments/nav_user :: nav}"></div>

    <div class="timesheet_container">
        <form id="timesheetForm" th:action="@{/timesheet}" th:object="${timesheetForm}" method="post">

            <div class="timesheet-header">
                <div>
                    <h2>New Weekly Timesheet</h2>
                </div>
                <div class="timesheet-period-selector">
                    <label for="dateSelector">Select Any Date in Week:</label>
                    <input type="date" id="dateSelector" required onchange="calculateWeek()">
                    <input type="hidden" id="payPeriodStart" th:field="*{payPeriodStart}">
                </div>
                <div class="week-display" id="weekDisplay" style="display: none;">
                    Week: <span id="weekRange"></span>
                </div>
                <div class="timesheet-actions">
                    <button type="submit" class="btn" style="background-color: #27ae60;">Submit Timesheet</button>
                </div>
            </div>

            <div class="timesheet-table-container">
                <table class="timesheet-table">
                    <thead>
                        <tr>
                            <th>Pay Code</th>
                            <th data-day="sun">Sun</th>
                            <th data-day="mon">Mon</th>
                            <th data-day="tue">Tue</th>
                            <th data-day="wed">Wed</th>
                            <th data-day="thu">Thu</th>
                            <th data-day="fri">Fri</th>
                            <th data-day="sat">Sat</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="timesheet-body">
                        <!-- Single row will be created here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>Total</td>
                            <td id="total-sun">0.0</td>
                            <td id="total-mon">0.0</td>
                            <td id="total-tue">0.0</td>
                            <td id="total-wed">0.0</td>
                            <td id="total-thu">0.0</td>
                            <td id="total-fri">0.0</td>
                            <td id="total-sat">0.0</td>
                            <td id="total-all">0.0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </form>
    </div>

    <div id="paycodeModal" class="modal paycode-modal">
        <div class="modal-content paycode-modal-content">
            <div class="modal-header">
                <h3>Select Pay Code</h3>
                <span class="modal-close" id="paycodeModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="paycode-search-input" placeholder="Search by name or code...">
                <ul id="paycode-results-list">
                </ul>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const ALL_PAY_CODES = /*[[${paycodes}]]*/ [];
        /*]]>*/
    </script>

    <script>
        // --- Global variables ---
        let currentPayCodeCell = null;
        let weekStartDate = null;

        // References to DOM elements
        let timesheetBody, modal, modalClose, searchInput, resultsList;

        // --- Week Calculation Logic ---
        function calculateWeek() {
            const dateInput = document.getElementById('dateSelector');
            const selectedDate = new Date(dateInput.value + 'T00:00:00');

            if (!dateInput.value || isNaN(selectedDate.getTime())) {
                document.getElementById('weekDisplay').style.display = 'none';
                return;
            }

            const dayOfWeek = selectedDate.getDay();
            const sunday = new Date(selectedDate);
            sunday.setDate(selectedDate.getDate() - dayOfWeek);

            const saturday = new Date(sunday);
            saturday.setDate(sunday.getDate() + 6);

            weekStartDate = sunday;

            const payPeriodStartInput = document.getElementById('payPeriodStart');
            payPeriodStartInput.value = formatDateForInput(sunday);

            const formatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('weekRange').textContent =
                formatter.format(sunday) + ' - ' + formatter.format(saturday);
            document.getElementById('weekDisplay').style.display = 'block';

            updateColumnHeaders(sunday);
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateColumnHeaders(startDate) {
            const formatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
            const headers = document.querySelectorAll('.timesheet-table thead th[data-day]');

            headers.forEach((th, index) => {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + index);

                const day = th.dataset.day.charAt(0).toUpperCase() + th.dataset.day.slice(1);
                th.textContent = `${day} (${formatter.format(currentDate)})`;
            });
        }

        // --- Pay Code Modal Logic ---
        function populatePayCodeList(filter = '') {
            resultsList.innerHTML = '';
            const lowerFilter = filter.toLowerCase();

            ALL_PAY_CODES.filter(pc =>
                pc.name.toLowerCase().includes(lowerFilter) ||
                pc.code.toLowerCase().includes(lowerFilter)
            ).forEach(pc => {
                const li = document.createElement('li');
                li.textContent = `[${pc.code}] ${pc.name}`;
                li.dataset.id = pc.id;
                li.dataset.display = `[${pc.code}] ${pc.name}`;
                li.onclick = function () { selectPayCode(this.dataset.id, this.dataset.display); };
                resultsList.appendChild(li);
            });
        }

        function openPayCodeModal(cell) {
            currentPayCodeCell = cell;
            populatePayCodeList();
            modal.style.display = 'block';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            setTimeout(() => searchInput.focus(), 100);
        }

        function closePayCodeModal() {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            searchInput.value = '';
        }

        function selectPayCode(id, display) {
            if (currentPayCodeCell) {
                currentPayCodeCell.querySelector('.paycode-selector').textContent = display;
                currentPayCodeCell.querySelector('input[type="hidden"]').value = id;
            }
            closePayCodeModal();
        }

        // --- Timesheet Grid Logic ---
        function createSingleRow() {
            const tr = document.createElement('tr');
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

            // 1. Pay Code Cell
            const tdPayCode = document.createElement('td');
            tdPayCode.className = 'cell-paycode';

            const payCodeSpan = document.createElement('span');
            payCodeSpan.className = 'paycode-selector';
            payCodeSpan.textContent = 'Click to select pay code';
            payCodeSpan.style.cursor = 'pointer';
            payCodeSpan.onclick = function () { openPayCodeModal(tdPayCode); };

            const hiddenPayCodeInput = document.createElement('input');
            hiddenPayCodeInput.type = 'hidden';
            hiddenPayCodeInput.name = 'entries[0].paycodeId';
            hiddenPayCodeInput.required = true;

            tdPayCode.appendChild(payCodeSpan);
            tdPayCode.appendChild(hiddenPayCodeInput);
            tr.appendChild(tdPayCode);

            // 2. Day Input Cells
            days.forEach(day => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'hour-input';
                input.name = `entries[0].hours[${day}]`;
                input.min = '0';
                input.step = '0.25';
                input.placeholder = '0.0';
                input.dataset.day = day;
                input.addEventListener('input', updateTotals);
                td.appendChild(input);
                tr.appendChild(td);
            });

            // 3. Row Total Cell
            const tdTotal = document.createElement('td');
            tdTotal.className = 'cell-total row-total';
            tdTotal.textContent = '0.0';
            tr.appendChild(tdTotal);

            timesheetBody.appendChild(tr);
        }

        function updateTotals() {
            let grandTotal = 0;
            const dayTotals = { sun: 0, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0 };

            const row = timesheetBody.querySelector('tr');
            if (row) {
                let rowTotal = 0;
                row.querySelectorAll('.hour-input').forEach(input => {
                    const val = parseFloat(input.value) || 0;
                    rowTotal += val;
                    dayTotals[input.dataset.day] += val;
                });
                row.querySelector('.row-total').textContent = rowTotal.toFixed(1);
                grandTotal += rowTotal;
            }

            Object.keys(dayTotals).forEach(day => {
                document.getElementById(`total-${day}`).textContent = dayTotals[day].toFixed(1);
            });
            document.getElementById('total-all').textContent = grandTotal.toFixed(1);
        }

        // --- Form Validation ---
        function validateForm() {
            if (!weekStartDate) {
                alert('Please select a date to determine the work week.');
                return false;
            }

            const payCodeInput = document.querySelector('input[name="entries[0].paycodeId"]');
            if (!payCodeInput || !payCodeInput.value) {
                alert('Please select a pay code for this timesheet.');
                return false;
            }

            const hourInputs = document.querySelectorAll('.hour-input');
            let hasHours = false;
            hourInputs.forEach(input => {
                if (parseFloat(input.value) > 0) {
                    hasHours = true;
                }
            });

            if (!hasHours) {
                alert('Please enter at least one hour for this timesheet.');
                return false;
            }

            return true;
        }

        // --- Main execution ---
        document.addEventListener('DOMContentLoaded', function () {
            timesheetBody = document.getElementById('timesheet-body');
            modal = document.getElementById('paycodeModal');
            modalClose = document.getElementById('paycodeModalClose');
            searchInput = document.getElementById('paycode-search-input');
            resultsList = document.getElementById('paycode-results-list');

            modalClose.onclick = closePayCodeModal;
            window.onclick = function (event) {
                if (event.target == modal) closePayCodeModal();
            }
            searchInput.addEventListener('input', () => populatePayCodeList(searchInput.value));

            document.getElementById('timesheetForm').addEventListener('submit', function (e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }
            });

            createSingleRow();

            const today = new Date();
            document.getElementById('dateSelector').value = formatDateForInput(today);
            calculateWeek();
        });

    </script>

</body>

</html>