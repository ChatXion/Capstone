<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Details - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Timesheet Details for <span th:text="${employeeFirstName + ' ' + employeeLastName}">Employee Name</span></h2>
                <p class="text-muted">Week <span th:text="${timesheet.week}">1</span> | Employee ID: <span th:text="${employeeId}">1</span></p>
            </div>
            <a th:href="@{/admin/view-timesheets/{id}(id=${employeeId})}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Timesheets
            </a>
        </div>

        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Status:</strong>
                        <span th:if="${timesheet.approvalStatus == 'pending'}" class="badge bg-warning">Pending</span>
                        <span th:if="${timesheet.approvalStatus == 'approved'}" class="badge bg-success">Approved</span>
                        <span th:if="${timesheet.approvalStatus == 'rejected'}" class="badge bg-danger">Rejected</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Total Hours:</strong> <span th:text="${timesheet.totalHours}">40.0</span>
                    </div>
                    <div class="col-md-3" th:if="${timesheet.approvedBy != null}">
                        <strong>Approved By:</strong> <span th:text="${timesheet.approvedBy}">Admin</span>
                    </div>
                    <div class="col-md-3" th:if="${timesheet.rejectionReason != null}">
                        <strong>Rejection Reason:</strong> <span th:text="${timesheet.rejectionReason}">Reason</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entries Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Timesheet Entries</h5>
            </div>
            <div class="card-body">
                <div th:if="${timesheet.entries == null or timesheet.entries.isEmpty()}" class="alert alert-info">
                    No entries in this timesheet.
                </div>
                
                <table th:if="${timesheet.entries != null and !timesheet.entries.isEmpty()}" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pay Code</th>
                            <th>Hours Worked</th>
                            <th>Hourly Rate</th>
                            <th>Total</th>
                            <th th:if="${timesheet.approvalStatus == 'pending'}">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="entry : ${timesheet.entries}">
                            <td th:text="${#temporals.format(entry.date, 'MM/dd/yyyy')}">01/01/2025</td>
                            <td>
                                <span th:text="${entry.payCodeName}">Regular Time</span>
                                <br/>
                                <small class="text-muted" th:text="${entry.payCodeCode}">REG</small>
                            </td>
                            <td th:text="${entry.hoursWorked}">8.0</td>
                            <td th:text="${entry.hourlyRate != null ? '$' + entry.hourlyRate : 'N/A'}">$25.00</td>
                            <td th:text="${entry.hourlyRate != null ? '$' + (entry.hoursWorked * entry.hourlyRate) : 'N/A'}">$200.00</td>
                            <td th:if="${timesheet.approvalStatus == 'pending'}">
                                <button class="btn btn-sm btn-warning"
                                        th:data-entry-id="${entry.id}"
                                        th:data-date="${entry.date}"
                                        th:data-hours="${entry.hoursWorked}"
                                        th:data-paycode-id="${entry.payCodeId}"
                                        th:data-paycode-name="${entry.payCodeName}"
                                        onclick="openEditModal(this)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger"
                                        th:data-entry-id="${entry.id}"
                                        th:data-date="${#temporals.format(entry.date, 'MM/dd/yyyy')}"
                                        th:data-hours="${entry.hoursWorked}"
                                        onclick="openDeleteModal(this)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-dark">
                            <td colspan="2"><strong>Total</strong></td>
                            <td><strong th:text="${timesheet.totalHours}">40.0</strong></td>
                            <td colspan="2" th:if="${timesheet.approvalStatus != 'pending'}"></td>
                            <td colspan="3" th:if="${timesheet.approvalStatus == 'pending'}"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal" style="display: none;" th:if="${timesheet.approvalStatus == 'pending'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Time Entry</h3>
            </div>
            <div class="modal-body">
                <form id="editEntryForm" method="post">
                    <input type="hidden" id="editEntryId" name="entryId">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="editDate" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Date</label>
                        <input type="date" id="editDate" name="date" required 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="editHours" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Hours Worked</label>
                        <input type="number" id="editHours" name="hoursWorked" step="0.5" min="0" max="24" required 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="editPayCode" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Pay Code</label>
                        <select id="editPayCode" name="payCodeId" required 
                                style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Select Pay Code</option>
                            <option th:each="payCode : ${payCodes}" 
                                    th:value="${payCode.id}" 
                                    th:text="${payCode.code + ' - ' + payCode.name}">
                                CODE - Name
                            </option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Entry Modal -->
    <div id="deleteEntryModal" class="modal" style="display: none;" th:if="${timesheet.approvalStatus == 'pending'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Time Entry</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this time entry?</p>
                <div style="background-color: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <span style="font-weight: bold;">Date:</span>
                        <span id="deleteEntryDate">Oct 01, 2023</span>
                    </div>
                    <div>
                        <span style="font-weight: bold;">Hours:</span>
                        <span id="deleteEntryHours">8.0</span>
                    </div>
                </div>
                <p style="color: #e74c3c; font-weight: 600; margin-top: 1rem;">This action cannot be undone.</p>
                <form id="deleteEntryForm" method="post">
                    <input type="hidden" id="deleteEntryId" name="entryId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDeleteForm()">Delete Entry</button>
            </div>
        </div>
    </div>

    <script th:if="${timesheet.approvalStatus == 'pending'}" th:inline="javascript">
        /*<![CDATA[*/
        const timesheetId = /*[[${timesheet.id}]]*/ 0;
        const employeeId = /*[[${employeeId}]]*/ 0;
        /*]]>*/
        
        function openEditModal(button) {
            const entryId = button.getAttribute('data-entry-id');
            const date = button.getAttribute('data-date');
            const hours = button.getAttribute('data-hours');
            const payCodeId = button.getAttribute('data-paycode-id');
            
            document.getElementById('editEntryId').value = entryId;
            document.getElementById('editDate').value = date;
            document.getElementById('editHours').value = hours;
            document.getElementById('editPayCode').value = payCodeId;
            
            // Set the form action with the actual entry ID
            const form = document.getElementById('editEntryForm');
            form.action = '/admin/view-timesheets/' + employeeId + '/' + timesheetId + '/entry/' + entryId + '/edit';
            
            document.getElementById('editEntryModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editEntryModal').style.display = 'none';
        }

        function submitEditForm() {
            document.getElementById('editEntryForm').submit();
        }

        function openDeleteModal(button) {
            const entryId = button.getAttribute('data-entry-id');
            const date = button.getAttribute('data-date');
            const hours = button.getAttribute('data-hours');
            
            document.getElementById('deleteEntryId').value = entryId;
            document.getElementById('deleteEntryDate').textContent = date;
            document.getElementById('deleteEntryHours').textContent = hours;
            
            // Set the form action with the actual entry ID
            const form = document.getElementById('deleteEntryForm');
            form.action = '/admin/view-timesheets/' + employeeId + '/' + timesheetId + '/entry/' + entryId + '/delete';
            
            document.getElementById('deleteEntryModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteEntryModal').style.display = 'none';
        }

        function submitDeleteForm() {
            document.getElementById('deleteEntryForm').submit();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editEntryModal');
            const deleteModal = document.getElementById('deleteEntryModal');
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>